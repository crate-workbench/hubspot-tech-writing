<p>Welcome to part 1 of our blog series on "Running Time Series Models in Production using CrateDB".</p>
<!--more-->
<h2>About</h2>
<p>In this blog post, we will introduce you to the concept of time series&nbsp;modeling, and discuss the main obstacles faced during its implementation in production. We will then introduce you to CrateDB, highlighting its key features and benefits, why it stands out in <a href="/solutions/time-series-database" rel="noopener">managing time series data</a>, and why it is an especially good fit for supporting machine learning models in production.</p>
<p>Whether you are a data scientist aiming to simplify your model deployment, a data engineer looking to enhance your data landscape, or a tech enthusiast keen on understanding the latest trends, this blog post will offer valuable insights and practical knowledge.</p>
<p>For readers familiar with <a href="https://en.wikipedia.org/wiki/Data_modeling" rel="noopener">data modeling,</a> it is important to distinguish that <a href="https://en.wikipedia.org/wiki/Time_series#Models" rel="noopener">time series modeling</a> is a different discipline.</p>
<h2>Overview</h2>
<h3 style="font-size: 20px; font-weight: bold;">Time Series Modeling</h3>
<p>Time series modeling is a crucial technique used across various sectors. Two main modeling techniques comprise the field of machine learning: Time series forecasting and anomaly detection.</p>
<p>Time series forecasting has applications in predicting future sales in retail, anticipating stock market trends in finance, predictive maintenance in manufacturing, user churn and subscription analysis in web applications, forecasting energy demand in utilities, and many others. It involves the use of statistical models to predict future values based on previously observed data.</p>
<h3 style="font-size: 20px; font-weight: bold;">Anomaly Detection</h3>
<p>Anomaly detection is used to identify outliers or unusual patterns in time series data. This detection technique uses statistical and machine learning algorithms to sift through large data sets over specific time intervals, analyzing patterns, trends, cycles, or seasonality, to spot deviations from the norm. These anomalies could either be an error or indicate another kind of significant event you would like to be alerted about.</p>
<p>Anomaly detection is widely used in multiple fields and industries, including cybersecurity, where it identifies unusual network activity patterns that could signify a potential breach, in finance for spotting fraudulent activities in credit card transactions; and in IoT for detecting malfunctioning sensors and machines. Other use cases include healthcare, for monitoring unusual patient vital signs, and predictive maintenance, where it is used to identify abnormal machine behavior, in order to prevent system failures.</p>
<h3 style="font-size: 20px; font-weight: bold;">CrateDB: the perfect fit for time series data</h3>
<p>While creating these models in itself is a challenging task, deploying them to production environments in a robust manner, is often equally challenging. More often than not, you will need to deal with large volumes of data, ensure real-time processing, manage and update feature stores, keep track of data and model versions, all while maintaining data accuracy and integrity.</p>
<p>This is where CrateDB comes into play. CrateDB is a <a href="/product/features/distributed-database" rel="noopener">distributed SQL database</a>, designed specifically to handle the unique demands of <a href="/solutions/time-series-database" rel="noopener">time series data</a>. It offers <a href="/product/features/speed-and-scalability" rel="noopener">scalability</a>, real-time data processing, and ease of use, making it an ideal choice for deploying time series and anomaly detection models. On top of that, CrateDB offers first-class analytical SQL support for time series data and binary blob data types, which makes it possible to store and retrieve machine learning models without needing extra infrastructure.</p>
<p>CrateDB is well integrated with the modern data processing and machine learning ecosystem through both its <a href="https://www.sqlalchemy.org/" rel="noopener">SQLAlchemy </a>dialect and its <a href="/product/features/postgresql-wire-protocol" rel="noopener">PostgreSQL</a> wire-protocol compatibility. It provides support and adapters for <a href="https://flink.apache.org/" rel="noopener">Apache Flink</a>, <a href="https://kafka.apache.org/" rel="noopener">Apache Kafka</a>, <a href="https://spark.apache.org/" rel="noopener">Apache Spark</a>, <a href="https://pandas.pydata.org/" rel="noopener">pandas</a>, <a href="https://www.dask.org/" rel="noopener">Dask</a>, as well as <a href="https://github.com/crate/ml-sandbox/blob/main/timeseries-data/article/01-about-intro.md#:~:text=as%20well%20as-,Apache%20Superset,-%2C%20Tableau%2C%20and" rel="noopener">Apache Superset</a>, <a href="https://crate.io/docs/crate/clients-tools/en/latest/integrate/analyze.html#business-intelligence-with-tableau" rel="noopener">Tableau</a>, and <a href="https://crate.io/partners/technology-partners" rel="noopener">many more</a>.</p>
<h2>Time Series&nbsp;Modeling</h2>
<p>Time series modeling is a statistical technique that utilizes sequential data to predict future values or events based on historical data. It involves analyzing patterns, trends, and seasonality in past data, to forecast future events. This type of forecasting is particularly useful when dealing with data that changes over time, such as stock prices, weather patterns, marketing &amp; sales data, or M2M/IoT data.</p>
<p>One of the key components of time series modeling is the understanding and interpretation of certain critical properties intrinsic to time series data, such as trend, seasonality, and cyclicality. Trend refers to the overall pattern or direction in which data is moving over a significant period. Seasonality are the recurring patterns or cycles that are typically observed within a specific time frame, be it daily, weekly, annually, etc. Cyclicality involves fluctuations that occur at irregular intervals, and cannot be linked to any particular season or event.</p>
<h3 style="font-size: 20px; font-weight: bold;">Applications</h3>
<p>The ability to accurately predict future events based on past data is invaluable in many sectors. For instance, online shops can forecast product demand to manage inventory, financial institutions can predict stock prices to make informed investment decisions, and manufacturing companies can anticipate machine maintenance downtimes to efficiently plan their production schedules. By making accurate predictions, businesses can make predictive, data-based decisions, reduce risks, and improve efficiency.</p>
<p>Furthermore, time series modeling is also useful for anomaly detection. Anomalies are data points that deviate from the expected pattern or trend. They can be caused by a variety of factors, such as human error, equipment malfunction, or cyber-attacks. By detecting anomalies early on, businesses can take corrective actions to prevent further damage. For instance, a manufacturing company can detect anomalies in their production process to prevent machine breakdowns and avoid costly downtimes.</p>
<h3 style="font-size: 20px; font-weight: bold;">Technical Background</h3>
<p>Various types of models are employed in time series analysis, each with its strengths and weaknesses. The simplest model is the autoregressive (AR) model, which assumes future values can be forecasted from a weighted sum of the past. The moving average (MA) model, on the other hand, assumes that future values are a function of the mean and various random error terms. More complex models, like autoregressive integrated moving average (ARIMA) and seasonal ARIMA (SARIMA), combine strategies from AR and MA models while also accounting for trends and seasonality. Additionally, state-of-the-art models like Long Short-Term Memory (LSTM), a type of recurrent neural network, are effective at capturing long-term dependencies in time series data.</p>
<p>More recent models for anomaly detection are Random Cut Forest (RCF), Variational Auto Encoders (VAE), which are both neural network-based, unsupervised learning algorithms (with VAEs surprisingly being also very good in semi-supervised and supervised learning applications). Honorable mentions in the field of time series anomaly detection are also the Isolation Forest (IF), One-Class Support Vector Machine (OCSVM) models, and the excellent prophet time series analysis library released by Facebook.</p>
<p>Furthermore, recent developments advise to not only use a single model for time series forecasting and anomaly detection, but multiple ones, called an ensemble. This technique uses multiple of the aforementioned models on the same data, and then combines their predictions to get a more accurate result.To get a practical hang of how time series modeling works, the next section will exercise a basic example.</p>
<h2>Example: Times Series Anomaly Detection for Machine Data</h2>
<h3 style="font-size: 20px; font-weight: bold;">Prologue</h3>
<p>NOTE: While this example should provide more depth to understanding time series modeling, it is not intended to teach the foundations of this field of data science. Instead, it will focus more on how to use machine learning models in production scenarios. However, if you are interested in learning more about time series modeling, we recommend to check out <a href="https://www.machinelearningplus.com/time-series/time-series-analysis-python/" rel="noopener">Time Series Analysis in Python â€“ A Comprehensive Guide with Examples, </a>by Selva Prabhakaran.</p>
<h3 style="font-size: 20px; font-weight: bold;">About</h3>
<p>The exercise will use the Numenta Anomaly Benchmark (NAB) dataset, which includes real-world and artificial time series data for anomaly detection research. We will choose the dataset about real measured temperature readings from a machine room. The goal is to detect anomalies in the temperature readings, which could indicate a malfunctioning machine. The dataset simulates machine temperature measurements, and will be loaded into CrateDB upfront.</p>
<h3 style="font-size: 20px; font-weight: bold;">Setup</h3>
<p>To follow this tutorial, load the <a href="https://github.com/numenta/NAB/raw/master/data/realKnownCause/machine_temperature_system_failure.csv" rel="noopener">machine_temperature_system_failure.csv</a> into your <a href="https://crate.io/products/cratedb-cloud" rel="noopener">CrateDB Cloud</a> cluster. Furthermore, install the prerequisites by running the following commands in your terminal.</p>
{% module_block module "widget_a0da0c12-3030-4cab-982c-03e1d7355511" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<pre><code>pip install 'crate[sqlalchemy]' crash pandas numpy==1.23.5 matplotlib salesforce-merlion\n</code></pre>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<p style="font-size: 18px; font-weight: normal;">Please note the following external dependencies of the <span style="font-size: 20px;"><code>merlion</code></span> library:</p>
<ul>
<li style="font-size: 18px; font-weight: normal;">Some of the forecasting models depend on OpenMP. If using <span style="font-size: 20px;"><code>conda</code></span>, please <span style="font-size: 20px;"><code>conda install -c conda-forge lightgbm </code></span>before installing the package. This will ensure that OpenMP is configured to work with the <span style="font-size: 20px;"><code>lightgbm</code></span> package (one of merlion's dependencies) in your <span style="font-size: 20px;"><code>conda</code></span> environment. If using Mac, please install <a href="https://brew.sh/" rel="noopener" target="_blank">Homebrew</a> and call <span style="font-size: 20px;"><code>brew install libomp</code></span> so that the OpenMP libary is available for the model.</li>
<li style="font-size: 18px; font-weight: normal;">Some of the anomaly detection models depend on the Java Development Kit (JDK). For Ubuntu, call <span style="font-size: 20px;"><code>sudo apt-get install openjdk-11-jdk</code></span>. For Mac OS, install Homebrew and call <span style="font-size: 20px;"><code>brew tap adoptopenjdk/openjdk &amp;&amp; brew install --cask adoptopenjdk11</code></span>. Also, ensure that <span style="font-size: 20px;"><code>java</code></span> can be found on your <span style="font-size: 20px;"><code>PATH</code></span>, and that the <span style="font-size: 20px;"><code>JAVA_HOME</code></span> environment variable is set.</li>
</ul>
<h3 style="font-size: 20px; font-weight: bold;">Importing Data</h3>
<p>If you are using <a href="https://crate.io/products/cratedb-cloud" rel="noopener">CrateDB Cloud</a>, navigate to the <a href="https://console.cratedb.cloud/" rel="noopener">Cloud Console</a>, and use the <a href="https://community.crate.io/t/importing-data-to-cratedb-cloud-clusters/1467#import-from-url-1" rel="noopener">Data Import</a> feature to import the CSV file directly from the given URL into the database table <span style="font-size: 20px;"><code>machine_data.</code></span></p>
<p><span style="font-size: 20px;"><a href="https://github.com/numenta/NAB/raw/master/data/realKnownCause/machine_temperature_system_failure.csv">https://github.com/numenta/NAB/raw/master/data/realKnownCause/machine_temperature_system_failure.csv</a>&nbsp;</span></p>
<p><span style="font-size: 20px;"><code><img src="https://cratedb.com/hubfs/cratedb-cloud-import-url.png" width="640" height="293" loading="lazy" alt="cratedb-cloud-import-url" style="height: auto; max-width: 100%; width: 640px;"></code></span></p>
<p style="font-size: 20px; font-weight: normal;"><span style="font-family: Arial, Helvetica, sans-serif;">The import process will automatically infer an SQL DDL schema from the shape of the data source. When visiting the <a href="/docs/crate/admin-ui/" rel="noopener">CrateDB Admin UI</a> after the import process has concluded, you can observe the <span style="font-size: 20px;"><code>machine_data</code></span> table was created and populated correctly.</span></p>
<p style="font-size: 20px; font-weight: normal;"><span style="font-family: Arial, Helvetica, sans-serif;"><img src="https://cratedb.com/hubfs/cratedb-admin-ui-data-imported.png" width="496" height="212" loading="lazy" alt="cratedb-admin-ui-data-imported" style="height: auto; max-width: 100%; width: 496px;"></span></p>
<p style="font-size: 18px; font-weight: normal;">If you want to exercise the data import on your workstation, use the <span style="font-size: 20px;"><code>crash</code></span> command-line program.</p>
{% module_block module "widget_b74fb69b-8b2f-4828-932f-17adc30b5da0" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<pre><code>crash --command 'CREATE TABLE IF NOT EXISTS \"machine_data\" (\"timestamp\" TIMESTAMP, \"value\" REAL);'\ncrash --command \"COPY machine_data FROM 'https://github.com/numenta/NAB/raw/master/data/realKnownCause/machine_temperature_system_failure.csv';\"\n</code></pre>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<p style="font-size: 18px; font-weight: normal;">Note: If you are connecting to CrateDB Cloud, use the options <span style="font-size: 20px;"><code>--hosts </code><code>'https://&lt;hostname&gt;:4200' --username '&lt;username&gt;'</code>.</span> In order to run the program non-interactively, without being prompted for a password, use <span style="font-size: 20px;"><code>export CRATEPW='&lt;password&gt;'</code></span>.</p>
<h3 style="font-size: 20px; font-weight: bold;">Loading Data</h3>
<p>First, you will load the dataset into a pandas DataFrame and convert the <span style="font-size: 20px;"><code>timestamp</code></span> column to a Python <span style="font-size: 20px;"><code>datetime</code></span> object.</p>
{% module_block module "widget_dea4d6f1-1a0b-4e5e-abea-f12e0daf0693" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<code>from crate import client\nimport pandas as pd\n\n# Connect to database.\nconn = client.connect(\n    \"https://&lt;your-instance&gt;.azure.cratedb.net:4200\",\n    username=\"admin\",\n    password=\"&lt;your-password&gt;\",\n    verify_ssl_cert=True)\n\n# Query and load data.\nwith conn:\n    cursor = conn.cursor()\n    cursor.execute(\"SELECT timestamp, value \"\n                   \"FROM machine_data ORDER BY timestamp ASC\")\n    data = cursor.fetchall()\n\n# Convert to pandas DataFrame.\ntime_series = pd.DataFrame(\n        [{'timestamp': pd.Timestamp.fromtimestamp(item[0] / 1000), 'value': item[1]}\n            for item in data])\n\n# Set the timestamp as the index.\ntime_series = time_series.set_index('timestamp')\n</code>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "line_wraps" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<h3 style="font-size: 20px; font-weight: bold;">Downsampling</h3>
<p><span style="font-weight: bold;">TIP:</span> CrateDB provides many useful analytical functions tailored for time series data. One of them is the <code>date_bin</code> which bins the input timestamp to the specified interval - which makes it very handy to resample data.</p>
<p>In general, for time series modeling, you often want to sample your data with a high frequency, in order not to miss any events. However, this results in huge data volumes, increasing the costs of model training. Here, it is best practice to down-sample your data to reasonable intervals.</p>
<p>This SQL statement demonstrates CrateDB's <span style="font-size: 20px;"><code>date_bin</code></span> function to down-sample the data to 5-minute intervals, reducing both the amount of data and the complexity of the modeling process.</p>
{% module_block module "widget_d0e2088a-622d-46fe-ae46-ffe0a86dbd09" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<pre><code>SELECT\n    DATE_BIN('5 min'::INTERVAL, \"timestamp\", 0) AS timestamp,\n    MAX(value) AS temperature\nFROM machine_data\nGROUP BY timestamp\nORDER BY timestamp ASC\n</code></pre>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<h3 style="font-size: 20px; font-weight: bold;">Plotting</h3>
<p>Next, plot the data to get a better understanding of the dataset.</p>
{% module_block module "widget_b04e18ab-e0ed-45b5-b2e1-699aa93c534b" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<pre><code>import pandas as pd\nimport matplotlib.pyplot as plt\nimport matplotlib.dates as mdates\n\nanomalies = [\n    [\"2013-12-15 17:50:00.000000\", \"2013-12-17 17:00:00.000000\"],\n    [\"2014-01-27 14:20:00.000000\", \"2014-01-29 13:30:00.000000\"],\n    [\"2014-02-07 14:55:00.000000\", \"2014-02-09 14:05:00.000000\"]\n]\n\nplt.figure(figsize=(12,7))\nline, = plt.plot(time_series.index, time_series['value'], linestyle='solid', color='black', label='Temperature')\n\n# Highlight anomalies\nctr = 0\nfor timeframe in anomalies:\n    ctr += 1\n    plt.axvspan(pd.to_datetime(timeframe[0]), pd.to_datetime(timeframe[1]), color='blue', alpha=0.3, label=f'Anomaly {ctr}')\n\n# Formatting x-axis for better readability\nplt.gca().xaxis.set_major_formatter(mdates.DateFormatter('%Y/%m/%d'))\nplt.gca().xaxis.set_major_locator(mdates.DayLocator(interval=7))\nplt.gcf().autofmt_xdate()  # Rotate &amp; align the x labels for a better view\n\nplt.title('Temperature Over Time', fontsize=20, fontweight='bold', pad=30)\nplt.ylabel('Temperature')\n# Add legend to the right\nplt.legend(bbox_to_anchor=(1.05, 1), loc='upper left')\n\nplt.tight_layout()\nplt.show()\n</code></pre>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<p><img src="https://cratedb.com/hubfs/Screenshot%202023-09-22%20at%2009.44.42.png" width="2016" height="1186" loading="lazy" alt="Machine Learning for Time Series Data" style="height: auto; max-width: 100%; width: 2016px;"></p>
<h3 style="font-size: 20px; font-weight: bold;">Observations</h3>
<p>Please note the blue highlighted areas above - these are real, <a href="https://github.com/numenta/NAB/tree/master/data" rel="noopener">observed anomalies in the dataset</a>. You will use them later to evaluate the model. The first anomaly is a planned shutdown of the machine. The second anomaly is difficult to detect and directly led to the third anomaly, a catastrophic failure of the machine.</p>
<p>You see that there are some nasty spikes in the data, which make anomalies hard to differentiate from ordinary measurements. However, as you will see later, modern models are quite good at finding exactly those spots.</p>
<h3 style="font-weight: bold; font-size: 20px;">Model Training</h3>
<p>To get there, let's train a small anomaly detection model. As mentioned in the introduction, there are a multitude of options to choose from. This post will not go into the very details of model selection, and will just use the <a href="https://github.com/salesforce/Merlion" rel="noopener">Merlion</a> library, an excellent open-source time series analysis package developed by Salesforce.<br><br>Merlion implements an end-to-end machine learning framework, that includes loading and transforming data, building and training models, post-processing model outputs, and evaluating model performance. It supports various time series learning tasks, including forecasting, anomaly detection, and change point detection.<br><br>Start by first splitting the dataset into training and test data. The exercise will use unsupervised learning, so you want to train the model on data without anomalies, and then check whether it is able to detect the anomalies in the test data. The data will be split at 2013-12-15.</p>
{% module_block module "widget_f35af293-f84c-4fc9-819c-26337f69984c" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<pre><code>from merlion.utils import TimeSeries\ntrain_data = TimeSeries.from_pd(time_series[time_series.index &lt; pd.to_datetime('2013-12-15')])\ntest_data = TimeSeries.from_pd(time_series[time_series.index &gt;= pd.to_datetime('2013-12-15')])\n</code></pre>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<p><img src="https://cratedb.com/hubfs/Screenshot%202023-09-22%20at%2009.52.44.png" width="2032" height="1160" loading="lazy" alt="Machine Learning for Time Series Data" style="height: auto; max-width: 100%; width: 2032px;"></p>
<p>Now, train the model using the Merlion <code>DefaultDetector</code>, which is an anomaly detection model that balances performance and efficiency. Under the hood, the<code>DefaultDetector</code> is an ensemble of an <a href="https://www.statsmodels.org/dev/examples/notebooks/generated/ets.html" rel="noopener">ETS model </a>and a <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/randomcutforest.html" rel="noopener">Random Cut Forest</a> model, both are excellent for general purpose anomaly detection.</p>
{% module_block module "widget_7532c67b-d207-42a4-9ed7-7a3f3eeaf8c3" %}{% module_attribute "child_css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "code" is_json="true" %}{% raw %}"<pre><code>from merlion.models.defaults import DefaultDetectorConfig, DefaultDetector\n\nmodel = DefaultDetector(DefaultDetectorConfig())\nmodel.train(train_data=train_data)\n</code></pre>"{% endraw %}{% end_module_attribute %}{% module_attribute "css" is_json="true" %}{% raw %}{}{% endraw %}{% end_module_attribute %}{% module_attribute "definition_id" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "field_types" is_json="true" %}{% raw %}{"code":"richtext","language":"choice","line_wraps":"boolean","margin_after_module":"number","show_copy_button":"boolean","show_line_numbers":"boolean"}{% endraw %}{% end_module_attribute %}{% module_attribute "label" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "module_id" is_json="true" %}{% raw %}111341816899{% endraw %}{% end_module_attribute %}{% module_attribute "path" is_json="true" %}{% raw %}"/sf2-crate/modules/Code Block"{% endraw %}{% end_module_attribute %}{% module_attribute "schema_version" is_json="true" %}{% raw %}2{% endraw %}{% end_module_attribute %}{% module_attribute "show_copy_button" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "show_line_numbers" is_json="true" %}{% raw %}true{% endraw %}{% end_module_attribute %}{% module_attribute "smart_objects" is_json="true" %}{% raw %}null{% endraw %}{% end_module_attribute %}{% module_attribute "smart_type" is_json="true" %}{% raw %}"NOT_SMART"{% endraw %}{% end_module_attribute %}{% module_attribute "tag" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "type" is_json="true" %}{% raw %}"module"{% endraw %}{% end_module_attribute %}{% module_attribute "wrap_field_tag" is_json="true" %}{% raw %}"div"{% endraw %}{% end_module_attribute %}{% end_module_block %}
<h3 style="font-size: 20px; font-weight: bold;">Evaluation</h3>
<p>Let's visually confirm the model performance:</p>
<p><img src="https://cratedb.com/hubfs/Screenshot%202023-09-22%20at%2011.48.43.png" width="768" height="412" loading="lazy" alt="Machine Learning for Time Series Data" style="height: auto; max-width: 100%; width: 768px;"></p>
<p>The model is able to detect the anomalies, a very good result for the first try, and without any parameter tuning. The next steps will bring this model to production.<br><br>In a real-world scenario, you want to further improve the model by tuning the parameters and evaluating the model performance on a validation dataset. However, for the sake of simplicity, this step will be skipped. Please refer to the <a href="https://github.com/crate/ml-sandbox/blob/main/timeseries-data/article/01-about-intro.md#:~:text=Merlion%20documentation" rel="noopener">Merlion documentation</a> for more information on how to do this.</p>
<p>If you're excited about the potential of time-series data and want to optimize your MLOps workflow, then you won't want to miss Part 2 of this post series. We'll show you how CrateDB supports MLOps using the powerful mlflow python library. And, in Part 3, we'll take it a step further by demonstrating how CrateDB alone can support an entire MLOps lifecycle. Stay tuned for more!</p>
